apiVersion: v1
data:
  pg_hba.conf: |
    # Default pg_hba.conf configuration
    # TYPE  DATABASE        USER            ADDRESS                 METHOD

    # "local" is for Unix domain socket connections only
    local   all             all                                     trust
    # IPv4 local connections:
    host    all             all             127.0.0.1/32            trust
    # IPv6 local connections:
    host    all             all             ::1/128                 trust
    # Allow replication connections from localhost, by a user with the
    # replication privilege.
    local   replication     all                                     trust
    host    replication     all             127.0.0.1/32            trust
    host    replication     all             ::1/128                 trust

    # Allow connections from any host with password authentication
    host    all             all             all                     md5
  postgresql.conf: |
    # PostgreSQL configuration file

    # Connection Settings
    listen_addresses = '*'
    max_connections = 100

    # Memory Settings
    shared_buffers = 128MB
    effective_cache_size = 4GB
    work_mem = 4MB
    maintenance_work_mem = 64MB

    # WAL Settings
    wal_buffers = 16MB

    # Checkpoint Settings
    checkpoint_completion_target = 0.7

    # Query Planner Settings
    random_page_cost = 1.1

    # Logging Settings
    log_destination = 'stderr'
    logging_collector = off
    log_min_messages = warning
    log_min_error_statement = error
    log_statement = 'none'
    log_min_duration_statement = -1

    # Shared Libraries

    # Locale and Formatting
    datestyle = 'iso, mdy'
    timezone = 'UTC'
    lc_messages = 'en_US.utf8'
    lc_monetary = 'en_US.utf8'
    lc_numeric = 'en_US.utf8'
    lc_time = 'en_US.utf8'
    default_text_search_config = 'pg_catalog.english'

    # Set pg_hba.conf file to use
    hba_file = '/etc/postgresql/pg_hba.conf'

    # Additional Configuration
kind: ConfigMap
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgres
    app.kubernetes.io/version: "18.0"
    helm.sh/chart: postgres-0.9.0
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-postgres
  namespace: keycloak
---
apiVersion: v1
data:
  realm-export.json: |
    {
      "realm": "tfm",
      "enabled": true,
      "displayName": "TFM Realm",
      "loginTheme": "tfm-theme",
      "registrationAllowed": true,
      "rememberMe": true,
      "resetPasswordAllowed": true,
      "registrationEmailAsUsername": true,
      "loginWithEmailAllowed": true,
      "clients": [
        {
          "clientId": "tfm-backend",
          "name": "TFM Backend",
          "protocol": "openid-connect",
          "publicClient": false,
          "bearerOnly": true,
          "directAccessGrantsEnabled": false,
          "standardFlowEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "redirectUris": [],
          "webOrigins": [],
          "protocolMappers": [
            {
              "name": "email",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "email",
                "claim.name": "email",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "given name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "firstName",
                "claim.name": "given_name",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "family name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "lastName",
                "claim.name": "family_name",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "username",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "username",
                "claim.name": "preferred_username",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            }
          ]
        },
        {
          "clientId": "tfm-frontend",
          "name": "TFM Frontend",
          "protocol": "openid-connect",
          "publicClient": true,
          "bearerOnly": false,
          "directAccessGrantsEnabled": true,
          "standardFlowEnabled": true,
          "implicitFlowEnabled": false,
          "serviceAccountsEnabled": false,
          "authorizationServicesEnabled": false,
          "fullScopeAllowed": true,
          "redirectUris": [
            "http://localhost:8088/*",
            "http://frontend:80/*"
          ],
          "webOrigins": [
            "http://localhost:8088",
            "http://frontend:80"
          ],
          "protocolMappers": [
            {
              "name": "email",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "email",
                "claim.name": "email",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "given name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "firstName",
                "claim.name": "given_name",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "family name",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "lastName",
                "claim.name": "family_name",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            },
            {
              "name": "username",
              "protocol": "openid-connect",
              "protocolMapper": "oidc-usermodel-property-mapper",
              "consentRequired": false,
              "config": {
                "user.attribute": "username",
                "claim.name": "preferred_username",
                "jsonType.label": "String",
                "id.token.claim": "true",
                "access.token.claim": "true"
              }
            }
          ]
        }
      ],
      "users": [
        {
          "username": "user",
          "enabled": true,
          "email": "user@example.com",
          "firstName": "User",
          "lastName": "Example",
          "emailVerified": true,
          "credentials": [
            {
              "type": "password",
              "value": "password",
              "temporary": false
            }
          ]
        }
      ],
      "smtpServer": {
        "host": "",
        "port": "",
        "from": "",
        "fromDisplayName": "",
        "replyTo": "",
        "replyToDisplayName": "",
        "envelopeFrom": ""
      }
    }
kind: ConfigMap
metadata:
  labels:
    app: keycloak
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-realm
  namespace: keycloak
---
apiVersion: v1
data:
  admin-password: NW5QVlBsMk9paVVqMmFFR2M0dmFNVUNCMmMzQjZtRVg=
kind: Secret
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/version: 26.4.7
    helm.sh/chart: keycloak-0.11.2
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak
  namespace: keycloak
type: Opaque
---
apiVersion: v1
data:
  db-password: U0hNcElCeEtBOThhdVBMMTNmYnNlUGdaZGZSajljYmY=
  db-username: cG9zdGdyZXM=
kind: Secret
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/version: 26.4.7
    helm.sh/chart: keycloak-0.11.2
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-db
  namespace: keycloak
type: Opaque
---
apiVersion: v1
data:
  database: a2V5Y2xvYWs=
  host: a2V5Y2xvYWstcG9zdGdyZXMua2V5Y2xvYWsuc3Zj
  port: NTQzMg==
  postgres-password: TjkwVUFoQkl5RXp0QklxWDBNS0hub0ZJS2w4RWlUNnU=
  uri: cG9zdGdyZXNxbDovL3Bvc3RncmVzOk45MFVBaEJJeUV6dEJJcVgwTUtIbm9GSUtsOEVpVDZ1QGtleWNsb2FrLXBvc3RncmVzLmtleWNsb2FrLnN2Yzo1NDMyL2tleWNsb2Fr
  username: cG9zdGdyZXM=
kind: Secret
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgres
    app.kubernetes.io/version: "18.0"
    helm.sh/chart: postgres-0.9.0
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-postgres
  namespace: keycloak
type: Opaque
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/version: 26.4.7
    helm.sh/chart: keycloak-0.11.2
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak
  namespace: keycloak
spec:
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/name: keycloak
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgres
    app.kubernetes.io/version: "18.0"
    helm.sh/chart: postgres-0.9.0
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-postgres
  namespace: keycloak
spec:
  ports:
    - name: postgresql
      port: 5432
      protocol: TCP
      targetPort: 5432
  selector:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/name: postgres
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgres
    app.kubernetes.io/version: "18.0"
    helm.sh/chart: postgres-0.9.0
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-postgres-headless
  namespace: keycloak
spec:
  clusterIP: None
  ports:
    - name: postgresql
      port: 5432
      protocol: TCP
      targetPort: 5432
  selector:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/name: postgres
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/version: 26.4.7
    helm.sh/chart: keycloak-0.11.2
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak
  namespace: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
      app.kubernetes.io/instance: keycloak
      app.kubernetes.io/name: keycloak
      tfm/cluster-group: keycloak
      tfm/name: keycloak
  template:
    metadata:
      labels:
        app: keycloak
        app.kubernetes.io/instance: keycloak
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: keycloak
        app.kubernetes.io/version: 26.4.7
        helm.sh/chart: keycloak-0.11.2
        tfm/cluster-group: keycloak
        tfm/name: keycloak
    spec:
      automountServiceAccountToken: false
      containers:
        - args:
            - start-dev
            - --http-enabled=true
            - --hostname-strict=false
            - --http-port=8080
            - --https-port=8443
            - --db=postgres
            - --db-url=jdbc:postgresql://keycloak-postgres:5432/keycloak
            - --import-realm
          command:
            - /opt/keycloak/bin/kc.sh
          env:
            - name: KC_HTTP_RELATIVE_PATH
              value: /
            - name: KC_BOOTSTRAP_ADMIN_USERNAME
              value: admin
            - name: KC_BOOTSTRAP_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: admin-password
                  name: keycloak
            - name: KC_DB
              value: postgres
            - name: KC_DB_USERNAME
              value: postgres
            - name: KC_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: postgres-password
                  name: keycloak-postgres
          image: us-central1-docker.pkg.dev/tfm-kubernetes/tfm/keycloak:1.0
          imagePullPolicy: Always
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /realms/master
              port: http
              scheme: HTTP
            initialDelaySeconds: 60
            periodSeconds: 30
            successThreshold: 1
            timeoutSeconds: 5
          name: keycloak
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /realms/master
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          resources: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
          startupProbe:
            failureThreshold: 60
            httpGet:
              path: /realms/master
              port: http
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          volumeMounts:
            - mountPath: /opt/keycloak/data
              name: data
            - mountPath: /tmp
              name: tmp
            - mountPath: /opt/keycloak/work
              name: keycloak-work
            - mountPath: /opt/keycloak/lib/quarkus
              name: keycloak-lib-quarkus
            - mountPath: /opt/keycloak/themes
              name: keycloak-themes
            - mountPath: /opt/keycloak/providers
              name: keycloak-providers
            - mountPath: /opt/keycloak/data/import/realm-export.json
              name: realm-export
              subPath: realm-export.json
      initContainers:
        - command:
            - sh
            - -c
            - cp -r /opt/keycloak/lib/quarkus/* /shared-quarkus/
          image: us-central1-docker.pkg.dev/tfm-kubernetes/tfm/keycloak:1.0
          imagePullPolicy: Always
          name: copy-quarkus-lib
          resources: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
          volumeMounts:
            - mountPath: /shared-quarkus
              name: keycloak-lib-quarkus
        - command:
            - sh
            - -c
            - until pg_isready -h keycloak-postgres -p 5432 -U postgres; do echo waiting for database; sleep 2; done;
          image: postgres:17.6@sha256:e6a4209d1a4893f2df3bdcde58f8926c3c929c4d51df90990ed1b36d83c1382a
          name: wait-for-postgres
          resources: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 1001
            runAsNonRoot: true
            runAsUser: 1001
        - args:
            - |
              set -e
              if [ -d /opt/keycloak/themes ]; then
                cp -r /opt/keycloak/themes/. /target-themes/
              fi
              if [ -d /opt/keycloak/providers ]; then
                cp -r /opt/keycloak/providers/. /target-providers/
              fi
          command:
            - /bin/sh
            - -c
          image: docker.io/keycloak/keycloak:26.4.7
          name: copy-bundled-themes
          volumeMounts:
            - mountPath: /target-themes
              name: keycloak-themes
            - mountPath: /target-providers
              name: keycloak-providers
      securityContext:
        fsGroup: 1001
      serviceAccountName: default
      volumes:
        - emptyDir: {}
          name: data
        - emptyDir: {}
          name: tmp
        - emptyDir: {}
          name: keycloak-work
        - emptyDir: {}
          name: keycloak-lib-quarkus
        - emptyDir: {}
          name: keycloak-providers
        - configMap:
            name: keycloak-realm
          name: realm-export
        - emptyDir: {}
          name: keycloak-themes
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: keycloak
    app.kubernetes.io/instance: keycloak
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/name: postgres
    app.kubernetes.io/version: "18.0"
    helm.sh/chart: postgres-0.9.0
    tfm/cluster-group: keycloak
    tfm/name: keycloak
  name: keycloak-postgres
  namespace: keycloak
spec:
  replicas: 1
  selector:
    matchLabels:
      app: keycloak
      app.kubernetes.io/instance: keycloak
      app.kubernetes.io/name: postgres
      tfm/cluster-group: keycloak
      tfm/name: keycloak
  serviceName: keycloak-postgres-headless
  template:
    metadata:
      labels:
        app: keycloak
        app.kubernetes.io/instance: keycloak
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: postgres
        app.kubernetes.io/version: "18.0"
        helm.sh/chart: postgres-0.9.0
        tfm/cluster-group: keycloak
        tfm/name: keycloak
    spec:
      automountServiceAccountToken: false
      containers:
        - args:
            - -c
            - config_file=/etc/postgresql/postgresql.conf
          env:
            - name: PGDATA
              value: /var/lib/postgresql/18/docker
            - name: POSTGRES_DB
              value: keycloak
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  key: postgres-password
                  name: keycloak-postgres
            - name: POSTGRES_MAX_CONNECTIONS
              value: "100"
          image: docker.io/postgres:18.0@sha256:073e7c8b84e2197f94c8083634640ab37105effe1bc853ca4d5fbece3219b0e8
          imagePullPolicy: Always
          livenessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  pg_isready -U postgres -d keycloak -h 127.0.0.1 -p 5432
            failureThreshold: 3
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          name: postgres
          ports:
            - containerPort: 5432
              name: postgresql
              protocol: TCP
          readinessProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  pg_isready -U postgres -d keycloak -h 127.0.0.1 -p 5432
            failureThreshold: 3
            initialDelaySeconds: 5
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 5
          resources: {}
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
            runAsGroup: 999
            runAsNonRoot: true
            runAsUser: 999
          startupProbe:
            exec:
              command:
                - /bin/bash
                - -c
                - |
                  pg_isready -U postgres -d keycloak -h 127.0.0.1 -p 5432
            failureThreshold: 30
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          volumeMounts:
            - mountPath: /var/lib/postgresql
              name: data
            - mountPath: /etc/postgresql
              name: config
            - mountPath: /var/run/postgresql
              name: run
            - mountPath: /tmp
              name: tmp
      securityContext:
        fsGroup: 999
      serviceAccountName: default
      volumes:
        - configMap:
            name: keycloak-postgres
            optional: true
          name: config
        - emptyDir: {}
          name: run
        - emptyDir: {}
          name: tmp
  updateStrategy:
    type: RollingUpdate
  volumeClaimTemplates:
    - metadata:
        labels:
          app: keycloak
          tfm/cluster-group: keycloak
          tfm/name: keycloak
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 8Gi

# server {
#   listen 80;

#   root /usr/share/nginx/html;
#   index index.html index.htm;

#   # SPA fallback
#   location / {
#     try_files $uri /index.html;
#   }

#   # WebSocket proxy to Quarkus
#   location /ws/tunnel {
#     proxy_pass http://backend:8080/ws/tunnel;
#     proxy_http_version 1.1;
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "upgrade";
#     proxy_set_header Host $host;
#   }
# }
# server {
#   listen 80;

#   root /usr/share/nginx/html;
#   index index.html index.htm;

#   # SPA fallback
#   location / {
#     try_files $uri /index.html;
#   }

#   # Proxy Guacamole WebApp (HTTP + WS) to the guacamole service
#   location /guacamole/ {
#     proxy_pass http://guacamole:8080/guacamole/;
#     proxy_http_version 1.1;

#     # websockets
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "upgrade";

#     # preserve host (optional but nice)
#     proxy_set_header Host $host;

#     # if behind reverse proxies add:
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_set_header X-Forwarded-For $remote_addr;
#   }
# }

# server {
#   listen 80;
#   server_name _;
#   root /usr/share/nginx/html;
#   index index.html;

#   # SPA fallback
#   location / { try_files $uri /index.html; }

#   # Use Docker DNS + defer resolution
#   resolver 127.0.0.11 ipv6=off valid=30s;
#   set $guac_upstream tfm-guacamole-1:8080;

#   location /guacamole/ {
#     proxy_pass http://$guac_upstream/guacamole/;
#     proxy_http_version 1.1;

#     # WebSocket upgrade
#     proxy_set_header Upgrade $http_upgrade;
#     proxy_set_header Connection "upgrade";

#     proxy_set_header Host $host;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_set_header X-Forwarded-For $remote_addr;
#   }
# }

server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  # Proxy your Quarkus WS endpoint
  resolver 127.0.0.11 ipv6=off valid=30s;
  set $backend tfm-backend-1:8080;

  location ^~ /ws/tunnel {
    proxy_pass http://$backend/ws/tunnel;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
  }

  # If you still also want Guacamole WebApp under /guacamole/ (optional)
  # location ^~ /guacamole/ { ... }

  # SPA fallback for React
  location / { try_files $uri /index.html; }
}

